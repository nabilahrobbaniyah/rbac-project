<!DOCTYPE html>
<html>
<head>
  <title>Dashboard Admin</title>
</head>
<body>

<h2>Dashboard Admin</h2>

<input id="search" placeholder="Search">
<button onclick="loadData()">Cari</button>
<button onclick="loadData(true)">Load All</button>
<button onclick="backToLogin()">Logout</button>

<table border="1">
  <thead>
    <tr>
      <th>No.</th>
      <th onclick="setSort('name')">Nama</th>
      <th onclick="setSort('department')">Departemen</th>
      <th>Hadir</th>
      <th>Waktu masuk</th>
      <th>Status</th>
      <th>Aksi</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
let page = 1;
let sort = '';
let loadAll = false;

const token = localStorage.getItem('token');
if (!token) {
  alert('Belum login');
  location.href = 'login.html';
}

function backToLogin() {
  localStorage.clear();
  window.location.href = 'login.html';
}

function setSort(col) {
  sort = col;
  loadData();
}

async function loadData(all = false) {
  loadAll = all;
   if (loadAll) {
    page = 1; // page tidak dipakai, tapi dinetralkan
  }
  const search = document.getElementById('search').value;

  let url = `http://localhost:3000/api/dashboard?page=${page}&sort=${sort}&search=${encodeURIComponent(search)}`;
  if (loadAll) {
    url += '&limit=all';
  } else {
    url += `&page=${page}`;
  }

  const res = await fetch(url, {
    headers: {
      Authorization: 'Bearer ' + token
    }
  });

  if (!res.ok) {
    alert('Gagal mengambil data: ' + res.status);
    return;
  }
  const result = await res.json();
  console.log('RESPONSE JSON:', result);

  render(result.data || [], result.role);
}

function render(data, role) {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';

  data.forEach((row, index) => {
    let aksi = '';

    if (role === 'Admin') {
      aksi = `
        <button onclick="editData(${row.id})">Edit</button>
        <button onclick="deleteData(${row.id})">Delete</button>
      `;
    } else if (role === 'Editor') {
      aksi = `
        <button onclick="editData(${row.id})">Edit</button>
      `;
    }

    tbody.innerHTML += `
      <tr>
        <td>${index + 1}</td>
        <td>${row.name}</td>
        <td>${row.department}</td>
        <td>${row.waktuMasuk ? 'Yes' : 'No'}</td>
        <td>${row.waktuMasuk ? new Date(row.waktuMasuk).toLocaleString() : '-'}</td>
        <td>${row.status || '-'}</td>
        <td>${aksi}</td>
      </tr>
    `;
  });
}

async function deleteData(id) {
  if (!confirm('Yakin ingin menghapus data ini?')) return;

  const res = await fetch(`http://localhost:3000/api/dashboard/${id}`, {
    method: 'DELETE',
    headers: {
      Authorization: 'Bearer ' + token
    }
  });

  if (res.ok) {
    alert('Data berhasil dihapus');
    loadData();
  } else {
    alert('Gagal menghapus data');
  }
}

async function editData(id) {
  const name = prompt('Nama baru:');
  const department = prompt('Departemen baru:');

  if (!name || !department) {
    alert('Edit dibatalkan');
    return;
  }

  const res = await fetch(`http://localhost:3000/api/dashboard/${id}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      Authorization: 'Bearer ' + token
    },
    body: JSON.stringify({ name, department })
  });

  if (res.ok) {
    alert('Data berhasil diupdate');
    loadData();
  } else {
    alert('Gagal update data');
  }
}


function next() {
  page++;
  loadData();
}

function prev() {
  if (page > 1) page--;
  loadData();
}

loadData();
</script>

</body>
</html>
